# CI/CD startup template v1.0
# Add this template to your project so that you can easily setup CI/CD on your project.
#
# This template contains the following features:
#   - Automatically triggers a build whenever new code is pushed to main, test, acceptance and production branches
#   - Automatically starts a release to the correct environement dependent on the branch that triggered the build
#

# BRANCHES THAT TRIGGER A BUILD
# Change the branch names (or add or remove branches) so that this fits your project
trigger:
 branches:
  include:
    - main
    - production

# PIPELINE VARIABLES
# Add here any variable that you need to use during the pipeline execution
variables:
- name: ASDatabaseName
  value: bla

# Branch names variables
# Change these variables to fit your project's needs  
- name: mainBranchName
  value: 'refs/heads/main'
  readonly: true
- name: productionBranchName
  value: 'refs/heads/production'
  readonly: true
  


stages:
# ------------------------------------------------------------------------
#                             DEPLOY
# ------------------------------------------------------------------------
# There is one stage per environement. Please remove the ones that do not apply
# to the current project

# ------- DEV -------
- stage: "Dev"
  displayName: "DEV"
  condition: eq(variables['Build.SourceBranch'], '${{ variables.mainBranchName }}')
  jobs:
    - deployment: Deploy
      pool:
        vmImage: "windows-latest"
      environment: Dev
      displayName: "DEV"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              - task: PowerShell@2
                displayName: Install tabular editor
                inputs:
                  targetType: 'inline'
                  script: |
                    $TabularEditorDownloadUrl = "https://github.com/otykier/TabularEditor/releases/download/2.12.4/TabularEditor.Portable.zip" 
                    
                    $DownloadDest = join-path (get-location) "TabularEditor.zip"
                    
                    Invoke-WebRequest -Uri $TabularEditorDownloadUrl -OutFile $DownloadDest
                    
                    Expand-Archive -Path $DownloadDest -DestinationPath (get-location).Path
                    Remove-Item $DownloadDest
              - task: CmdLine@2
                displayName: Best Practice Analysis
                inputs:
                  script: 'TabularEditor.exe "TestAAS/Model.bim" -A -V'

              - task: CmdLine@2
                displayName: Deploy Model
                inputs:
                  script: 'TabularEditor.exe "TestAAS/Model.bim" -D "Provider=MSOLAP;Data Source=asazure://westeurope.asazure.windows.net/joaollqtest;Initial Catalog=<Initial Catalog>;Password=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiJodHRwczovL3dlc3RldXJvcGUuYXNhenVyZS53aW5kb3dzLm5ldCIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzQ1OGYxMzY2LTdlYjgtNDJhNC1hM2I3LThmNzYzMDMzZjYyNy8iLCJpYXQiOjE2MjIxMTQxMTksIm5iZiI6MTYyMjExNDExOSwiZXhwIjoxNjIyMTE4MDE5LCJhaW8iOiJFMlpnWU9qK2N5ZXl2ZTZMcmVpMHZxUWwreVlrQUFBPSIsImFwcGlkIjoiYzRkYzgwZmEtYmZkZC00ZTVjLWEyZmMtYmU3M2ZkNDk1YmQ2IiwiYXBwaWRhY3IiOiIxIiwiaWRwIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvNDU4ZjEzNjYtN2ViOC00MmE0LWEzYjctOGY3NjMwMzNmNjI3LyIsIm9pZCI6ImQ0YjQ1NzBhLTdiYzgtNDNlNS05NzM3LTdhNGI1YjE3Y2IzOCIsInJoIjoiMC5BUkFBWmhPUFJiaC1wRUtqdDQ5Mk1EUDJKX3FBM01UZHYxeE9vdnktY18xSlc5WVFBQUEuIiwic3ViIjoiZDRiNDU3MGEtN2JjOC00M2U1LTk3MzctN2E0YjViMTdjYjM4IiwidGlkIjoiNDU4ZjEzNjYtN2ViOC00MmE0LWEzYjctOGY3NjMwMzNmNjI3IiwidXRpIjoiZWphaFpiV082RTJZNk9BQ3ZkZlBBQSIsInZlciI6IjEuMCJ9.U6R-mAiiGEx_j0CnK-TXuHSRWs-F6fzysHZYWn8B6BnC7ErDbXezR75Pggv535UlF4ENTYwue9BNIPKIFS5N0JUu9qxHmxUZd6JdLZZB1BcFeN3oftrke6I9dnBE-qVAyzW859nLAdyz3DOGBgdBqN07LnBtWR8kFj2ySvW6iv3s0v7YJLzACsAjX1RPKipLblFcfoB42eWXKF0IeZqek0CRjStjHn2il0oNKfh4p9iciWLnq8w7SXSJtrs9OhkMr14TExiw078z_GxPfdmpCjrtiKpk3LHobNuSz4OC_x-M66wJ7Dh3XH6NGZ_3E3FhSlqyA5u-z5JMXDQF51BvPg;Persist Security Info=True;Impersonation Level=Impersonate" "$(ASDatabaseName)" -O -C -P -R -M -W -E -V'
